<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const node_pty_1 = require("node-pty");
const events_1 = require("events");
/**
 * Usage example:
 * ```js
 * const client = new CliDriver()
 * await client.start()
 * TODO
 * ```
 */
class CliDriver extends events_1.EventEmitter {
    constructor() {
        super(...arguments);
        this.defaultOptions = {
            name: 'xterm-color',
            cols: 80,
            rows: 30,
            cwd: process.env.cwd,
            env: process.env
        };
        this.data = [];
        this.lastWrite = 0;
        // WAIT
        this._waitTimeout = 10000;
        this._waitInterval = 500;
    }
    start(options) {
        options = options || {};
        const shellCommand = os.platform() === 'win32' ? 'powershell.exe' : 'bash';
        const ptyOptions = Object.assign({}, this.defaultOptions, options);
        this.ptyProcess = node_pty_1.spawn(shellCommand, [], ptyOptions);
        this.ptyProcess.on('data', data => {
            this.emit(CliDriver.EVENT_DATA, data);
        });
        this.on(CliDriver.EVENT_DATA, data => {
            this.handleData(data);
        });
        return Promise.resolve();
    }
    destroy() {
        this.ptyProcess.destroy();
        return Promise.resolve();
    }
    handleData(data) {
        this.data.push({
            data,
            timestamp: Date.now()
        });
    }
    // WRITE
    /**
     * Will write given text and then press ENTER
     * @param str the string to enter
     */
    enter(str) {
        return this.write(str + '\r');
    }
    /**
     * @param str writes given text. Notice that this won't submit ENTER. For that you need to append "\r" or use @link enter
     */
    write(str) {
        this.ptyProcess.write(str);
        this.lastWrite = Date.now(); // TODO: all the performance magic should happen here - we should acomodate all the data
        return Promise.resolve();
    }
    // READ
    /**
     * get current data from last time enter() was issued
     * @param {number} lastWrite Optional get data from given time
     */
    getDataFromLastWrite(lastWrite = this.lastWrite) {
        // make this more performant but storing last index and last data returned index we know is less than this.lastwrite so we dont have to iterate all the array and concatenate all again
        return this.getDataFromTimestamp(this.lastWrite);
    }
    /**
     * @param {number} timestamp Optional get data from given time
     */
    getDataFromTimestamp(timestamp) {
        // make this more performant but storing last index and last data returned index we know is less than this.lastwrite so we dont have to iterate all the array and concatenate all again
        let i = 0;
        for (; i &lt; this.data.length; i++) {
            if (this.data[i].timestamp > timestamp) {
                break;
            }
        }
        let dataFrom = '';
        for (; i &lt; this.data.length; i++) {
            dataFrom += this.data[i].data;
        }
        return Promise.resolve(dataFrom);
    }
    // private allData: string = ''
    // private allDataLastIndex: number = 0
    getAllData() {
        // TODO: make it performant by storing all data and only concatenate from allDataLastIndex
        let ad = '';
        this.data.forEach(d => ad += d.data);
        return Promise.resolve(ad);
    }
    /**
     * for how long wait* function will wait until it return a rejected promise
     * @type {number}
     */
    set waitTimeout(t) {
        this._waitTimeout = t;
    }
    /**
     * how periodically wait* functions will poll to check given predicate
     * @type {number}
     */
    set waitInterval(t) {
        this._waitInterval = t;
    }
    /**
     * will wait until new data matches given predicate. If not predicate is given will return the next data chunk that comes.
     * @param {Function} predicate
     * @param {number} [timeout]
     * @param {number} [interval]
     */
    waitForData(predicate, timeout = this._waitTimeout, interval = this._waitInterval, afterTimestamp = this.lastWrite) {
        let intervalId;
        const checkData = async (resolve) => {
            const data = await this.getDataFromTimestamp(afterTimestamp);
            if (predicate(data)) {
                clearInterval(intervalId);
                resolve(data);
            }
            else {
                setTimeout(async () => {
                    checkData(resolve);
                }, timeout);
            }
        };
        // TODO: make me faster please!
        const promise = new Promise((resolve, reject) => {
            if (predicate) {
                intervalId = setInterval(async () => {
                    checkData(resolve);
                }, interval);
                setTimeout(() => {
                    reject('TIMEOUT, use CmdClient.waitTimeout property to increase it ?');
                }, timeout);
            }
            else {
                this.once(CliDriver.EVENT_DATA, data => resolve(data));
            }
        });
        return promise;
    }
    // MISC
    dumpState() {
        return Promise.resolve({ data: this.data, lastWrite: this.lastWrite });
    }
}
// CORE
CliDriver.EVENT_DATA = 'pty-data';
exports.default = CliDriver;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CliDriver.html">CliDriver</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-sample_tutorial.html">Just An Example Tutorial</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Apr 07 2018 15:46:50 GMT-0300 (-03)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
